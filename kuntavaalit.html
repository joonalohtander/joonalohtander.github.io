<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Joona Lohtander" />


<title>Yle kuntavaalikoneen data</title>

<script src="site_libs/header-attrs-2.27/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/yeti.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-6.4.2/css/all.min.css" rel="stylesheet" />
<link href="site_libs/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>









<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Joona Lohtander</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">About me</a>
</li>
<li>
  <a href="https://www.joonasolutions.com">Joona Solutions</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="mailto:&lt;mail@joonasolutions.com&gt;">
    <span class="fa fa-envelope fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="http://github.com/joonalohtander/">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://www.linkedin.com/in/joona-lohtander/">
    <span class="fa fa-linkedin"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Yle kuntavaalikoneen data</h1>
<h4 class="author">Joona Lohtander</h4>

</div>


<div id="yleisesti-datan-haravoinnista-ja-ohjelmistorajapinnoista"
class="section level2">
<h2>Yleisesti datan haravoinnista ja ohjelmistorajapinnoista</h2>
<p>Jos haluat käyttöösi netissä julkisena saatavilla olevaa dataa,
käytössäsi on käytännössä kolme vaihtoehtoa. Paras vaihtoehto on käyttää
datan julkaisijan ohjelmointirajapintaa tai muuta datan julkaisijan
hyväksymää keinoa. Toiseksi paras vaihtoehto on kysyä, voisitko saada
datan suoraan. Huonoin vaihtoehto on se, että joudut turvautumaan
verkkoharavointiin, mikä on hidasta ja saattaa aiheuttaa ei-toivottua
liikennettä datan julkaisijalle. Jos kuitenkin päätät turvautua
verkkoharavointiin, tarkista ensin julkaisijan <a
href="https://www.robotstxt.org/"><em>robots.txt</em></a> -tiedosto.
Varmista myös, että verkkoharavointi tapahtuu niin, ettei liikennettä
synny kohtuuttomasti. Myös ohjelmointirajapintoja käytettäessä on hyvä
pitää mielessä rajapintaan kohdistuva rasitus. Eikä pelkästään siksi,
että liika rasitus voi johtaa esimerkiksi IP-osoitteesi väliaikaiseen
tai pysyväänkin estämiseen.</p>
</div>
<div id="ylen-kunta--ja-aluevaalikone" class="section level2">
<h2>Yle:n kunta- ja aluevaalikone</h2>
<p>Yle on julkaissut kunta- ja aluevaalikoneensa osoitteessa <a
href="https://vaalit.yle.fi/vaalikone/alue-ja-kuntavaalit2025"
class="uri">https://vaalit.yle.fi/vaalikone/alue-ja-kuntavaalit2025</a>.</p>
<p>Vaalikoneen vastauksia voi selailla kunnittain Ylen
käyttöliittymällä. Jos kuitenkin haluat tutkia vaalikoneen vastauksia
laajemmin, vastaukset ja vastaajien tiedot ovat saatavilla Yle:n
julkisen ohjelmointirajapinnan (API) kautta. Ohjelmointirajapintaa ei
ole dokumentoitu, mutta olennaiset tiedot ovat helposti pääteltävissä
vaalikoneen verkkoliikennettä seuraamalla. Esimerkiksi Oulun
kuntavaalikoneen vastaajien tiedot löytyvät osoitteesta <a
href="https://vaalit.yle.fi/vaalikone/alue-ja-kuntavaalit2025/api/public/municipality/constituencies/155/candidates"
class="uri">https://vaalit.yle.fi/vaalikone/alue-ja-kuntavaalit2025/api/public/municipality/constituencies/155/candidates</a>.
Tässä osoitteessa <em>155</em> on Oulun kuntakoodi. Käyttämällä hieman
maalaisjärkeä, voidaan päätellä riittävät tiedot kandidaattien
vastauksien keräämiseksi ohjelmointirajapinnan kautta.</p>
</div>
<div id="python-koodi" class="section level2">
<h2>Python koodi</h2>
<p>Kirjoitin alla olevan koodin koko Suomen vaalikonevastaajien datan
keräämiseksi Pythonilla. Koodi hakee ensin tiedot vaalipiirien
ehdokkaista ja sitten tiedot ehdokkaiden vastauksista.</p>
<p>Huomioitavaa tässä on, että jos Yle:n ohjelmointirajapinta palauttaa
virhekoodin, Python “nukkuu” (sleep) viiden sekunnin ajan ja kokeilee
sitten uudelleen, mutta enintään kolme kertaa. Kaikista kandidaateista
ei siis välttämättä saada tietoja, jos esimerkiksi nettiyhteys pätkii
tai jos Yle:n ohjelmointirajapinnan rajoitukset tulevat vastaan. Toinen
huomioitava asia on lukuisat for-loopit, joita lähtökohtaisesti
kannattaisi välttää, jos saman asian voi toteuttaa jotenkin
rinnakkaistamalla. Tässä tapauksessa kuitenkin on parempi tehdä
API-kutsut yksi kerrallaan ja välttää API:n ruuhkauttamista.</p>
<pre class="python"><code>import time
import requests
import pandas as pd

# Define the API endpoint
API_URL = &quot;https://vaalit.yle.fi/vaalikone/alue-ja-kuntavaalit2025/api/public/municipality/constituencies/&quot; 

def fetch(api_url):
    try:
        response = requests.get(api_url)
        response.raise_for_status()  # Raise an error for bad responses (4xx, 5xx)
        json = response.json()  # Parse the JSON response

        return json

    except requests.exceptions.RequestException as e:
        print(f&quot;Error fetching data: {e}&quot;)
        return None  # Return None in case of error

def process_candidate_data(candidate_data, constituency_id):
    candidate_info = {
        &quot;id&quot;: candidate_data.get(&quot;id&quot;, 0),
        &quot;first_name&quot;: candidate_data.get(&quot;first_name&quot;, &quot;&quot;),
        &quot;last_name&quot;: candidate_data.get(&quot;last_name&quot;, &quot;&quot;),
        &quot;party_id&quot;: candidate_data.get(&quot;party_id&quot;, &quot;&quot;),
        &quot;constituency_id&quot;: constituency_id,
        &quot;gender&quot;: candidate_data.get(&quot;info&quot;, {}).get(&quot;gender&quot;, {}).get(&quot;name_en&quot;, &quot;&quot;),
        &quot;age&quot;: candidate_data.get(&quot;info&quot;, {}).get(&quot;age&quot;, 0),
        &quot;education&quot;: candidate_data.get(&quot;info&quot;, {}).get(&quot;education&quot;, {}).get(&quot;name_en&quot;, &quot;&quot;),
        &quot;left_right_axis&quot;: candidate_data.get(&quot;info&quot;, {}).get(&quot;left_right_axis&quot;, {}).get(&quot;name_en&quot;, &quot;&quot;),
        &quot;language&quot;: candidate_data.get(&quot;info&quot;, {}).get(&quot;language&quot;, {}).get(&quot;name_en&quot;, &quot;&quot;),
        &quot;liberal_conservative_axis&quot;: candidate_data.get(&quot;info&quot;, {}).get(&quot;liberal_conservative_axis&quot;, {}).get(&quot;name_en&quot;, &quot;&quot;)
    }

    # Extract answers in long format
    answers_list = []
    for question_id, answer_details in candidate_data.get(&quot;answers&quot;, {}).items():
        if isinstance(answer_details, dict) and &quot;answer&quot; in answer_details and answer_details[&quot;answer&quot;]:
            answers_list.append({
                &quot;candidate_id&quot;: candidate_info[&quot;id&quot;],
                &quot;first_name&quot;: candidate_info[&quot;first_name&quot;],
                &quot;last_name&quot;: candidate_info[&quot;last_name&quot;],
                &quot;party_id&quot;: candidate_info[&quot;party_id&quot;],
                &quot;constituency_id&quot;: candidate_info[&quot;constituency_id&quot;],
                &quot;gender&quot;: candidate_info[&quot;gender&quot;],
                &quot;age&quot;: candidate_info[&quot;age&quot;],
                &quot;education&quot;: candidate_info[&quot;education&quot;],
                &quot;left_right_axis&quot;: candidate_info[&quot;left_right_axis&quot;],
                &quot;language&quot;: candidate_info[&quot;language&quot;],
                &quot;liberal_conservative_axis&quot;: candidate_info[&quot;liberal_conservative_axis&quot;],
                &quot;question_id&quot;: int(question_id),
                &quot;answer_value&quot;: answer_details[&quot;answer&quot;],
            })
    
    # Return the processed answers list
    return answers_list

# Fetch the data and print the DataFrame
df_constituencies = fetch(API_URL)
df_constituencies = pd.DataFrame(df_constituencies)

# Fetch data on candidates
i = 0
df_candidates_list = []

for constituency_id in df_constituencies[&quot;id&quot;]:
    retries = 2
    while retries &gt;= 0:
        try:
            candidates_in_constituency = fetch(f&quot;{API_URL}{constituency_id}/candidates&quot;)
            df_candidates_in_constituency = pd.DataFrame(candidates_in_constituency)
            break
        except Exception as e:
            print(f&quot;Error fetching candidates for constituency {constituency_id}: {e}&quot;)
            if retries == 0:
                print(&quot;Skipping this constituency after multiple failures.&quot;)
                break 
            time.sleep(5)
            retries -= 1

    for candidate_id in df_candidates_in_constituency[&quot;id&quot;]:
        print(f&quot;Fetching data for candidate {candidate_id} in constituency {constituency_id}&quot;)
        retries = 2
        while retries &gt;= 0:
            try:
                candidate_data = fetch(f&quot;{API_URL}{constituency_id}/candidates/{candidate_id}&quot;)
                df_candidates_list.extend(process_candidate_data(candidate_data, constituency_id))
                break
            except Exception as e:
                print(f&quot;Error fetching data for candidate {candidate_id}: {e}&quot;)
                if retries == 0:
                    print(&quot;Skipping this candidate after multiple failures.&quot;)
                    break
                time.sleep(5)
                retries -= 1

# Convert list to DataFrame
df_candidates = pd.DataFrame(df_candidates_list)

# Save to csv
df_candidates.to_csv(&quot;data/candidates.csv&quot;)
df_constituencies.to_csv(&quot;data/constituencies.csv&quot;)</code></pre>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
